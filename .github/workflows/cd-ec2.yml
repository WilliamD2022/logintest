name: CD - Deploy to EC2

on:
  # dispara automaticamente quando o CI terminar
  workflow_run:
    workflows: ["CI - Maven (build, test, package)"]  # nome EXATO do seu CI
    types: [completed]
  # permite rodar manualmente pelo botÃ£o "Run workflow"
  workflow_dispatch: {}

jobs:
  deploy:
    # sÃ³ continua se o CI tiver dado sucesso na branch main
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    runs-on: ubuntu-latest

    # Modo simulado por padrÃ£o (troque para 'false' para deploy real)
    env:
      SIMULATE_DEPLOY: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Baixa o artefato "simple-auth-jar" do CI
      - name: Download artifact from CI run
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ci.yml                 # arquivo do seu CI
          workflow_conclusion: success
          name: simple-auth-jar            # mesmo nome que vocÃª publica no CI
          path: .                          # baixa na raiz do workspace

      - name: List artifact
        run: ls -lh

      # --------- SIMULAÃ‡ÃƒO (sem AWS) ----------
      - name: Simulate deploy (no AWS)
        if: env.SIMULATE_DEPLOY == 'true'
        run: |
          echo "ðŸ“¦ Simulando deploy..."
          test -f ./*.jar || (echo "JAR nÃ£o encontrado" && exit 1)
          cp ./*.jar /tmp/simple-auth.jar
          ls -lh /tmp/simple-auth.jar
          echo "âœ… SimulaÃ§Ã£o concluÃ­da."

      # --------- DEPLOY REAL (com AWS) ----------
      - name: Add known_hosts
        if: env.SIMULATE_DEPLOY != 'true'
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.EC2_PORT || 22 }}" "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Copy JAR to EC2 (/tmp)
        if: env.SIMULATE_DEPLOY != 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          source: "*.jar"                    # baixado na etapa anterior
          target: "/tmp/simple-auth.jar"
          overwrite: true

      - name: Run remote deploy script
        if: env.SIMULATE_DEPLOY != 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            set -e
            RELEASE="$(date +'%Y-%m-%d_%H-%M-%S')__${GITHUB_SHA::7}"
            sudo /opt/simple-auth/deploy.sh "$RELEASE"
            echo "âœ… Deploy real concluÃ­do: $RELEASE"
