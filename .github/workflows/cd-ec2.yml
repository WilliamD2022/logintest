name: CD - Deploy to EC2

on:
  push:
    branches: [ "main" ]   # roda a cada push na main
  workflow_dispatch: {}     # permite rodar manualmente pelo botÃ£o "Run workflow"

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Modo de simulaÃ§Ã£o (troque para 'false' quando for deploy real)
    env:
      SIMULATE_DEPLOY: true

    defaults:
      run:
        working-directory: com.login.william   # seu pom.xml estÃ¡ aqui

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Build (skip tests â€” CI jÃ¡ valida)
        run: mvn -B -DskipTests clean package

      - name: Rename JAR
        run: |
          JAR=$(ls target/*.jar | head -n1)
          cp "$JAR" target/simple-auth.jar
          ls -lh target/

      # --------- SIMULAÃ‡ÃƒO (sem AWS) ----------
      - name: Simular cÃ³pia para EC2
        if: env.SIMULATE_DEPLOY == 'true'
        run: |
          echo "ðŸ“¦ Simulando deploy (sem AWS)..."
          cp target/simple-auth.jar $GITHUB_WORKSPACE/simple-auth.jar
          ls -lh $GITHUB_WORKSPACE/simple-auth.jar
          echo "âœ… SimulaÃ§Ã£o concluÃ­da."

      # --------- DEPLOY REAL (com AWS) ----------
      - name: Add known_hosts
        if: env.SIMULATE_DEPLOY != 'true'
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.EC2_PORT || 22 }}" "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Copy JAR to EC2
        if: env.SIMULATE_DEPLOY != 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          source: "com.login.william/target/simple-auth.jar"
          target: "/tmp/simple-auth.jar"
          overwrite: true

      - name: Remote deploy script
        if: env.SIMULATE_DEPLOY != 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            set -e
            RELEASE="$(date +'%Y-%m-%d_%H-%M-%S')__${GITHUB_SHA::7}"
            sudo /opt/simple-auth/deploy.sh "$RELEASE"
