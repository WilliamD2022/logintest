name: CD - Deploy to EC2

on:
  # dispara automaticamente quando o CI terminar
  workflow_run:
    workflows: ["CI - Maven (build, test, package)"]
    types: [completed]
  # permite rodar manualmente pelo botÃ£o "Run workflow"
  workflow_dispatch: {}

jobs:
  deploy:
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    runs-on: ubuntu-latest

    env:
      # ðŸ” mostra todos os comandos no log do GitHub Actions
      ACTIONS_STEP_DEBUG: true
      # ðŸ” simulaÃ§Ã£o ativada por padrÃ£o (mude para 'false' p/ deploy real)
      SIMULATE_DEPLOY: true

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“¥ Baixar artefato do CI (simple-auth-jar)
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ci.yml
          workflow_conclusion: success
          name: simple-auth-jar
          path: .
      - name: ðŸ”Ž Listar artefatos baixados
        run: |
          echo "Listando artefatos disponÃ­veis:"
          ls -lh

      # ----------------------------------------------------------------
      # SIMULAÃ‡ÃƒO (sem AWS)
      # ----------------------------------------------------------------
      - name: ðŸ¤– Simular deploy local (sem AWS)
        if: env.SIMULATE_DEPLOY == 'true'
        run: |
          echo "ðŸš€ Iniciando simulaÃ§Ã£o de deploy..."
          echo "Verificando se o JAR existe..."
          test -f ./*.jar || (echo "âŒ JAR nÃ£o encontrado!" && exit 1)
          echo "Copiando JAR para /tmp/simple-auth.jar"
          cp ./*.jar /tmp/simple-auth.jar
          echo "ðŸ“¦ Arquivo copiado:"
          ls -lh /tmp/simple-auth.jar
          echo "âœ… SimulaÃ§Ã£o concluÃ­da com sucesso!"

      # ----------------------------------------------------------------
      # DEPLOY REAL (com AWS)
      # ----------------------------------------------------------------
      - name: ðŸ§  Adicionar host remoto aos conhecidos
        if: env.SIMULATE_DEPLOY != 'true'
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.EC2_PORT || 22 }}" "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts
          echo "âœ… Host remoto adicionado ao known_hosts"

      - name: ðŸ“¤ Copiar JAR para EC2 (/tmp)
        if: env.SIMULATE_DEPLOY != 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          source: "*.jar"
          target: "/tmp/simple-auth.jar"
          overwrite: true

      - name: ðŸ§© Executar script remoto de deploy
        if: env.SIMULATE_DEPLOY != 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            set -e
            RELEASE="$(date +'%Y-%m-%d_%H-%M-%S')__${GITHUB_SHA::7}"
            echo "ðŸš€ Iniciando deploy da release $RELEASE..."
            sudo /opt/simple-auth/deploy.sh "$RELEASE"
            echo "âœ… Deploy concluÃ­do com sucesso!"
