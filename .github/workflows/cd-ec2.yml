jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SIMULATE_DEPLOY: true   # <--- muda pra false quando quiser deploy real
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build app
        working-directory: com.login.william
        run: mvn -B clean package -DskipTests

      - name: Simular cÃ³pia para EC2
        if: env.SIMULATE_DEPLOY == 'true'
        run: |
          echo "ðŸ“¦ SimulaÃ§Ã£o de deploy iniciada..."
          echo "Gerando arquivo: /tmp/simple-auth.jar"
          cp com.login.william/target/simple-auth.jar /tmp/simple-auth.jar
          ls -lh /tmp/simple-auth.jar
          echo "âœ… SimulaÃ§Ã£o concluÃ­da (nenhuma conexÃ£o com EC2 foi feita)."

      - name: Copiar JAR real para EC2
        if: env.SIMULATE_DEPLOY != 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          source: "com.login.william/target/simple-auth.jar"
          target: "/tmp/simple-auth.jar"

      - name: Executar deploy remoto (real)
        if: env.SIMULATE_DEPLOY != 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            set -e
            RELEASE="release_$(date +'%Y%m%d-%H%M%S')"
            echo "ðŸš€ Deploy real executado com release: $RELEASE"
            sudo /opt/simple-auth/deploy.sh "$RELEASE"
